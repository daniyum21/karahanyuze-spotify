name: Deploy to HostMonster

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

# Cancel any in-progress deployments when a new one starts
concurrency:
  group: deploy-to-hostmonster
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, pdo_mysql, gd, zip, curl, fileinfo, bcmath
          tools: composer:v2
          
      - name: üì¶ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      - name: üì¶ Install Composer dependencies
        run: |
          composer install --optimize-autoloader --no-dev --prefer-dist --no-interaction --no-progress
          
      - name: üì¶ Cache NPM dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: üì¶ Install NPM dependencies
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: üî® Build assets
        run: |
          npm run build
          
      - name: üî® Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy-package
          
          # Copy files excluding unnecessary ones
          rsync -av \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='storage/app/Audios' \
            --exclude='storage/app/Pictures' \
            --exclude='storage/app/public' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='deploy-package' \
            --exclude='docker-compose.yml' \
            --exclude='.github' \
            --exclude='*.md' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.editorconfig' \
            --exclude='database export' \
            --exclude='new look' \
            --exclude='oldApp' \
            --exclude='fix-mysql.sh' \
            --exclude='import-database.sh' \
            . deploy-package/
          
          # Create tarball and show size
          tar -czf deploy-package.tar.gz -C deploy-package .
          echo "üì¶ Deployment package size:"
          ls -lh deploy-package.tar.gz
          echo "üìä Package contents size:"
          du -sh deploy-package/
          
      - name: üì§ Upload to HostMonster via SCP
        id: scp-upload
        uses: appleboy/scp-action@v0.1.7
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || '22' }}
          source: "deploy-package.tar.gz"
          target: "~/"
          timeout: 600s
          strip_components: 0
          overwrite: true
          debug: true
          use_insecure_cipher: true
          
      - name: ‚è≥ Wait 10 seconds before retry
        if: steps.scp-upload.outcome == 'failure'
        run: sleep 10
        
      - name: üîÑ Retry SCP upload (if failed)
        if: steps.scp-upload.outcome == 'failure'
        id: scp-retry
        uses: appleboy/scp-action@v0.1.7
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || '22' }}
          source: "deploy-package.tar.gz"
          target: "~/"
          timeout: 600s
          strip_components: 0
          overwrite: true
          debug: true
          use_insecure_cipher: true
          
      - name: ‚ö†Ô∏è  SSH Connection Failed
        if: steps.scp-upload.outcome == 'failure' && steps.scp-retry.outcome == 'failure'
        run: |
          echo "‚ùå SSH connection failed after retries"
          echo ""
          echo "This is likely a server-side issue with HostMonster:"
          echo "  - SSH service might be down"
          echo "  - Firewall might be blocking connections"
          echo "  - Port might be incorrect"
          echo ""
          echo "Please check:"
          echo "  1. SSH is enabled in HostMonster cPanel"
          echo "  2. SSH port is correct (default: 22)"
          echo "  3. Firewall/security settings"
          echo ""
          echo "See MANUAL_DEPLOY.md for manual deployment instructions."
          exit 1
          
      - name: üöÄ Deploy on HostMonster
        id: ssh-deploy
        if: steps.scp-upload.outcome == 'success' || steps.scp-retry.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 600s
          command_timeout: 600s
          debug: true
          use_insecure_cipher: true
          script: |
            set -e
            
            echo "üîß Starting deployment process..."
            
            # Create private directory if it doesn't exist
            mkdir -p private/karahanyuze-spotify
            
            # Extract Laravel app to private directory
            echo "üìÇ Extracting Laravel app to private directory..."
            tar -xzf deploy-package.tar.gz -C private/karahanyuze-spotify
            
            # Copy public folder contents to public_html/iwacu (preserving other domain folders)
            echo "üìÇ Copying public files to public_html/iwacu (preserving other domains)..."
            mkdir -p public_html/iwacu
            if [ -d "private/karahanyuze-spotify/public" ]; then
              # Use rsync without --delete and exclude other domain folders
              rsync -av \
                --exclude='indirimbo' \
                --exclude='kinyarwanda' \
                private/karahanyuze-spotify/public/ public_html/iwacu/
              echo "‚úÖ Public files copied to public_html/iwacu (other domains preserved)"
            else
              echo "‚ö†Ô∏è  Warning: public folder not found in package"
            fi
            
            # IMPORTANT: Backup or remove old index.php in public_html (prevents serving old code)
            echo "üîß Checking for old index.php in public_html..."
            cd ~/public_html
            if [ -f "index.php" ] && [ ! -L "index.php" ]; then
              echo "‚ö†Ô∏è  Found old index.php in public_html - backing it up..."
              mv index.php index.php.old-backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || mv index.php index.php.old-backup
              echo "‚úÖ Old index.php backed up - this prevents serving old code"
            fi
            
            # Update .htaccess in public_html to point to iwacu/index.php
            echo "üîß Updating .htaccess in public_html to point to iwacu..."
            if [ -f ".htaccess" ]; then
              # Backup original
              cp .htaccess .htaccess.backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || cp .htaccess .htaccess.backup
              
              # Copy new .htaccess from iwacu (which has the correct rules)
              if [ -f "iwacu/.htaccess" ]; then
                echo "üìã Copying .htaccess from iwacu to public_html..."
                cp iwacu/.htaccess .htaccess
                echo "‚úÖ .htaccess updated from iwacu"
              else
                # Fallback: update manually
                echo "üìù Updating .htaccess manually..."
                sed -i "s|RewriteRule ^ index.php \[L\]|RewriteRule ^ iwacu/index.php [L]|g" .htaccess || true
                echo "‚úÖ .htaccess updated manually"
              fi
            else
              echo "‚ö†Ô∏è  Warning: .htaccess not found in public_html"
            fi
            
            # Update index.php to point to private directory
            echo "üîß Updating index.php paths..."
            cd ~/public_html/iwacu
            if [ -f "index.php" ]; then
              # Backup original
              cp index.php index.php.backup
              
              # Update paths to point to private directory
              sed -i "s|__DIR__.'/../vendor/autoload.php'|__DIR__.'/../../private/karahanyuze-spotify/vendor/autoload.php'|g" index.php
              sed -i "s|__DIR__.'/../bootstrap/app.php'|__DIR__.'/../../private/karahanyuze-spotify/bootstrap/app.php'|g" index.php
              
              echo "‚úÖ index.php updated"
            else
              echo "‚ö†Ô∏è  Warning: index.php not found"
            fi
            
            # Set up environment
            cd ~/private/karahanyuze-spotify
            
            # Clear caches FIRST before checking .env (important for fresh config)
            echo "üßπ Clearing all caches before environment setup..."
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan view:clear || true
            php artisan route:clear || true
            
            # Preserve existing .env file
            if [ -f .env ]; then
              echo "‚úÖ Using existing .env file"
              
              # Ensure DB_CONNECTION is set to mysql (not sqlite)
              if ! grep -q "^DB_CONNECTION=" .env; then
                echo "üîß Setting DB_CONNECTION to mysql..."
                echo "" >> .env
                echo "# Database Connection" >> .env
                echo "DB_CONNECTION=mysql" >> .env
                echo "‚úÖ DB_CONNECTION set to mysql"
              else
                DB_CONNECTION_VALUE=$(grep "^DB_CONNECTION=" .env | cut -d '=' -f2 | tr -d ' ')
                if [ "$DB_CONNECTION_VALUE" != "mysql" ]; then
                  echo "‚ö†Ô∏è  DB_CONNECTION is set to $DB_CONNECTION_VALUE (should be mysql)"
                  echo "üîß Updating DB_CONNECTION to mysql..."
                  sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|g" .env
                  echo "‚úÖ DB_CONNECTION updated to mysql"
                else
                  echo "‚úÖ DB_CONNECTION is correctly set to mysql"
                fi
              fi
              
              # Clear config cache again after .env changes
              echo "üßπ Clearing config cache after .env changes..."
              php artisan config:clear || true
              
              # Check if APP_KEY is missing or empty, if so generate it
              APP_KEY_VALUE=$(grep "^APP_KEY=" .env 2>/dev/null | cut -d '=' -f2- | tr -d ' ')
              if [ -z "$APP_KEY_VALUE" ] || [ "$APP_KEY_VALUE" = "" ]; then
                echo "üîë Generating application key..."
                php artisan key:generate --force
                echo "‚úÖ Application key generated"
              else
                echo "‚úÖ APP_KEY already exists in .env"
              fi
              
              # Check if APP_CIPHER is missing or incorrect, set it to aes-256-gcm (default for Laravel 12)
              if ! grep -q "^APP_CIPHER=" .env; then
                echo "üîê Setting APP_CIPHER to aes-256-gcm..."
                echo "" >> .env
                echo "# Application Cipher" >> .env
                echo "APP_CIPHER=aes-256-gcm" >> .env
                echo "‚úÖ APP_CIPHER set"
              else
                # Check if cipher is supported
                APP_CIPHER_VALUE=$(grep "^APP_CIPHER=" .env | cut -d '=' -f2 | tr -d ' ')
                if [ "$APP_CIPHER_VALUE" != "aes-128-cbc" ] && [ "$APP_CIPHER_VALUE" != "aes-256-cbc" ] && [ "$APP_CIPHER_VALUE" != "aes-128-gcm" ] && [ "$APP_CIPHER_VALUE" != "aes-256-gcm" ]; then
                  echo "‚ö†Ô∏è  APP_CIPHER is set to unsupported value: $APP_CIPHER_VALUE"
                  echo "üîê Updating APP_CIPHER to aes-256-gcm..."
                  sed -i "s|^APP_CIPHER=.*|APP_CIPHER=aes-256-gcm|g" .env
                  echo "‚úÖ APP_CIPHER updated to aes-256-gcm"
                else
                  echo "‚úÖ APP_CIPHER is correctly set to $APP_CIPHER_VALUE"
                fi
              fi
            else
              if [ -f .env.example ]; then
                echo "üìù Copying .env.example to .env"
                cp .env.example .env
                echo "üîë Generating application key..."
                php artisan key:generate --force
                echo "üîê Setting APP_CIPHER to aes-256-gcm..."
                if ! grep -q "^APP_CIPHER=" .env; then
                  echo "" >> .env
                  echo "# Application Cipher" >> .env
                  echo "APP_CIPHER=aes-256-gcm" >> .env
                fi
                echo "‚ö†Ô∏è  IMPORTANT: Please update .env file with your production settings!"
              else
                echo "‚ö†Ô∏è  .env file not found! Please create one manually."
              fi
            fi
            
            # Create necessary directories
            echo "üìÅ Creating storage directories..."
            mkdir -p storage/logs
            mkdir -p storage/framework/cache/data
            mkdir -p storage/framework/sessions
            mkdir -p storage/framework/views
            mkdir -p storage/app/public
            mkdir -p storage/app/Audios
            mkdir -p storage/app/Pictures
            mkdir -p bootstrap/cache
            
            # Set permissions
            echo "üîê Setting permissions..."
            chmod -R 755 storage
            chmod -R 755 bootstrap/cache
            chmod -R 775 storage/logs
            chmod -R 775 storage/framework
            
            # Clear all caches first (IMPORTANT: Must clear config cache before checking DB)
            echo "üßπ Clearing caches..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            
            # Test database connection and run migrations (if .env exists)
            if [ -f .env ]; then
              echo "üîç Testing database connection..."
              
              # Verify DB_CONNECTION is set correctly in .env
              if grep -q "^DB_CONNECTION=mysql" .env; then
                echo "‚úÖ DB_CONNECTION is set to mysql in .env"
              else
                echo "‚ö†Ô∏è  DB_CONNECTION is not set to mysql, fixing..."
                if grep -q "^DB_CONNECTION=" .env; then
                  sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|g" .env
                else
                  echo "DB_CONNECTION=mysql" >> .env
                fi
                echo "‚úÖ DB_CONNECTION updated to mysql"
                # Clear config cache again after changing .env
                php artisan config:clear || true
              fi
              
              # Test database connection (skip table count check to save time)
              if php artisan db:show 2>&1 | grep -q "Connection:"; then
                echo "‚úÖ Database connection successful"
              else
                echo "‚ùå Database connection failed!"
                echo "   Please check your .env database settings:"
                echo "   - DB_CONNECTION=mysql (should be set)"
                echo "   - DB_HOST, DB_PORT, DB_DATABASE"
                echo "   - DB_USERNAME, DB_PASSWORD"
                echo "   - Database server must be accessible from this server"
                echo ""
                echo "   Current DB_CONNECTION value:"
                grep "^DB_CONNECTION=" .env || echo "   (not set)"
              fi
              
              # Run migrations
              echo "üóÑÔ∏è  Running database migrations..."
              if php artisan migrate --force 2>&1; then
                echo "‚úÖ Migrations completed successfully"
              else
                echo "‚ö†Ô∏è  Migration failed or migrations already applied"
                echo "   This is normal if migrations are already up to date"
              fi
            else
              echo "‚ö†Ô∏è  Skipping migrations - .env file not found"
              echo "   To run migrations manually:"
              echo "   1. Create/upload .env file to ~/private/karahanyuze-spotify/"
              echo "   2. Run: cd ~/private/karahanyuze-spotify && php artisan migrate --force"
            fi
            
            # Run optimizations
            echo "‚ö° Running optimizations..."
            php artisan config:cache || echo "‚ö†Ô∏è  Config cache failed"
            php artisan route:cache || echo "‚ö†Ô∏è  Route cache failed"
            # Don't cache views - they change frequently and caching can cause issues
            php artisan view:clear || echo "‚ö†Ô∏è  View clear failed"
            
            # Create symbolic link from public_html/iwacu/storage to private storage
            cd ~/public_html/iwacu
            if [ ! -L storage ] && [ ! -d storage ]; then
              echo "üîó Creating storage symbolic link..."
              ln -s ~/private/karahanyuze-spotify/storage/app/public storage
              echo "‚úÖ Storage link created"
            elif [ -L storage ]; then
              echo "‚úÖ Storage link already exists"
            else
              echo "‚ö†Ô∏è  Storage directory exists as regular folder, not creating link"
            fi
            
            # Final cache clear to ensure fresh views are served
            echo "üßπ Final cache clear..."
            php artisan view:clear || true
            php artisan cache:clear || true
            
            # Clean up
            rm -f ~/deploy-package.tar.gz
            
            echo "‚úÖ Deployment completed successfully!"
            echo "üìÇ Laravel app: ~/private/karahanyuze-spotify/"
            echo "üåê Public files: ~/public_html/iwacu/"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANT REMINDERS:"
            echo "   1. Ensure storage/app/Audios/ and storage/app/Pictures/ are uploaded separately"
            echo "   2. Verify .env file has correct production settings"
            echo "   3. Check file permissions (storage and bootstrap/cache should be writable)"
            echo "   4. Other domain folders (indirimbo, kinyarwanda) have been preserved"
            echo "   5. Clear browser cache (Cmd+Shift+R or Ctrl+Shift+R) to see new styles"
            
      - name: ‚è≥ Wait 10 seconds before SSH retry
        if: steps.ssh-deploy.outcome == 'failure'
        run: sleep 10
        
      - name: üîÑ Retry SSH deployment (if failed)
        if: steps.ssh-deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 600s
          command_timeout: 600s
          debug: true
          use_insecure_cipher: true
          script: |
            set -e
            
            echo "üîß Starting deployment process (Retry)..."
            
            # Create private directory if it doesn't exist
            mkdir -p private/karahanyuze-spotify
            
            # Check if package exists
            if [ ! -f ~/deploy-package.tar.gz ]; then
              echo "‚ùå Deployment package not found. Upload may have failed."
              exit 1
            fi
            
            # Extract Laravel app to private directory
            echo "üìÇ Extracting Laravel app to private directory..."
            tar -xzf deploy-package.tar.gz -C private/karahanyuze-spotify
            
            # Copy public folder contents to public_html/iwacu (preserving other domain folders)
            echo "üìÇ Copying public files to public_html/iwacu (preserving other domains)..."
            mkdir -p public_html/iwacu
            if [ -d "private/karahanyuze-spotify/public" ]; then
              # Use rsync without --delete and exclude other domain folders
              rsync -av \
                --exclude='indirimbo' \
                --exclude='kinyarwanda' \
                private/karahanyuze-spotify/public/ public_html/iwacu/
              echo "‚úÖ Public files copied to public_html/iwacu (other domains preserved)"
            else
              echo "‚ö†Ô∏è  Warning: public folder not found in package"
            fi
            
            # IMPORTANT: Backup or remove old index.php in public_html (prevents serving old code)
            echo "üîß Checking for old index.php in public_html..."
            cd ~/public_html
            if [ -f "index.php" ] && [ ! -L "index.php" ]; then
              echo "‚ö†Ô∏è  Found old index.php in public_html - backing it up..."
              mv index.php index.php.old-backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || mv index.php index.php.old-backup
              echo "‚úÖ Old index.php backed up - this prevents serving old code"
            fi
            
            # Update .htaccess in public_html to point to iwacu/index.php
            echo "üîß Updating .htaccess in public_html to point to iwacu..."
            if [ -f ".htaccess" ]; then
              # Backup original
              cp .htaccess .htaccess.backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || cp .htaccess .htaccess.backup
              
              # Copy new .htaccess from iwacu (which has the correct rules)
              if [ -f "iwacu/.htaccess" ]; then
                echo "üìã Copying .htaccess from iwacu to public_html..."
                cp iwacu/.htaccess .htaccess
                echo "‚úÖ .htaccess updated from iwacu"
              else
                # Fallback: update manually
                echo "üìù Updating .htaccess manually..."
                sed -i "s|RewriteRule ^ index.php \[L\]|RewriteRule ^ iwacu/index.php [L]|g" .htaccess || true
                echo "‚úÖ .htaccess updated manually"
              fi
            else
              echo "‚ö†Ô∏è  Warning: .htaccess not found in public_html"
            fi
            
            # Update index.php to point to private directory
            echo "üîß Updating index.php paths..."
            cd ~/public_html/iwacu
            if [ -f "index.php" ]; then
              # Backup original
              cp index.php index.php.backup
              
              # Update paths to point to private directory
              sed -i "s|__DIR__.'/../vendor/autoload.php'|__DIR__.'/../../private/karahanyuze-spotify/vendor/autoload.php'|g" index.php
              sed -i "s|__DIR__.'/../bootstrap/app.php'|__DIR__.'/../../private/karahanyuze-spotify/bootstrap/app.php'|g" index.php
              
              echo "‚úÖ index.php updated"
            else
              echo "‚ö†Ô∏è  Warning: index.php not found"
            fi
            
            # Set up environment
            cd ~/private/karahanyuze-spotify
            
            # Preserve existing .env file
            if [ -f .env ]; then
              echo "‚úÖ Using existing .env file"
              
              # Ensure DB_CONNECTION is set to mysql
              if ! grep -q "^DB_CONNECTION=mysql" .env; then
                if grep -q "^DB_CONNECTION=" .env; then
                  sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|g" .env
                else
                  echo "DB_CONNECTION=mysql" >> .env
                fi
              fi
            fi
            
            # Create necessary directories
            echo "üìÅ Creating storage directories..."
            mkdir -p storage/logs storage/framework/cache/data storage/framework/sessions storage/framework/views storage/app/public storage/app/Audios storage/app/Pictures bootstrap/cache
            
            # Set permissions
            echo "üîê Setting permissions..."
            chmod -R 755 storage bootstrap/cache
            chmod -R 775 storage/logs storage/framework
            
            # Clear caches
            echo "üßπ Clearing caches..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            
            # Run migrations if .env exists (with error handling)
            if [ -f .env ]; then
              echo "üóÑÔ∏è  Running database migrations..."
              php artisan migrate --force 2>&1 | head -20 || echo "‚ö†Ô∏è  Migration failed or already applied"
            fi
            
            # Run optimizations
            echo "‚ö° Running optimizations..."
            php artisan config:cache || echo "‚ö†Ô∏è  Config cache failed"
            php artisan route:cache || echo "‚ö†Ô∏è  Route cache failed"
            # Don't cache views - they change frequently and caching can cause issues
            php artisan view:clear || echo "‚ö†Ô∏è  View clear failed"
            
            # Create storage link
            cd ~/public_html/iwacu
            if [ ! -L storage ] && [ ! -d storage ]; then
              ln -s ~/private/karahanyuze-spotify/storage/app/public storage
            fi
            
            # Clean up
            rm -f ~/deploy-package.tar.gz
            
            echo "‚úÖ Deployment completed successfully (Retry)!"
            
      - name: ‚úÖ Check deployment status
        run: |
          if [ "${{ steps.ssh-deploy.outcome }}" == "success" ] || [ "${{ steps.ssh-deploy.outcome }}" == "failure" ]; then
            echo "‚úÖ Deployment completed (may have succeeded even if step shows failure)"
            echo "üåê Your application should be live!"
            echo ""
            echo "Note: SSH connection issues at the end don't always mean deployment failed."
            echo "Check your website to verify it's working."
          else
            echo "‚ö†Ô∏è  Deployment status unclear"
          fi
          
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -rf deploy-package
          rm -f deploy-package.tar.gz

